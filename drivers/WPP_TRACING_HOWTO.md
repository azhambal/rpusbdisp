# WPP Tracing Integration Guide

This document explains how to integrate Windows software trace PreProcessor (WPP) tracing into the RoboPeak USB Display drivers.

## Overview

WPP tracing has been prepared for all three driver components:
- **UsbTransportUmdf** - USB transport layer tracing
- **UsbDisplayIdd** - Display and swap-chain tracing
- **UsbTouchHidUmdf** - Touch HID tracing

## Files Created

Each driver has a `Trace.h` header file that defines:
- Trace control GUID (unique for each driver)
- Trace flags (categories of trace messages)
- Convenience macros for common trace patterns

## Visual Studio Project Configuration

### 1. Enable WPP Preprocessor

For each driver project (`.vcxproj`):

1. Right-click project → **Properties**
2. Go to **Configuration Properties** → **WPP Tracing** → **General**
3. Set **Run WPP Tracing**: **Yes**
4. Set **Scan Configuration Data**: `Trace.h`

### 2. Configure WPP Settings

Under **WPP Tracing** → **File Options**:
- **File Name**: Leave default (or set to `$(IntDir)Wpp`)
- **Preprocessor Definitions**: Add any required definitions

### 3. Add WPP to Build Process

The WPP preprocessor will automatically:
- Scan `Trace.h` for WPP configuration
- Generate `.tmh` files for each `.cpp` file
- These `.tmh` files contain the actual trace macros

## Code Integration

### Driver.cpp

Add WPP initialization and cleanup:

```cpp
#include "Driver.h"
#include "Trace.h"
#include "Driver.tmh"  // Auto-generated by WPP

extern "C" DRIVER_INITIALIZE DriverEntry;

extern "C" NTSTATUS DriverEntry(
    _In_ PDRIVER_OBJECT  DriverObject,
    _In_ PUNICODE_STRING RegistryPath
)
{
    // Initialize WPP Tracing
    WPP_INIT_TRACING(DriverObject, RegistryPath);

    TRACE_FUNCTION_ENTRY(TRACE_DRIVER);

    WDF_DRIVER_CONFIG config;
    WDF_DRIVER_CONFIG_INIT(&config, UsbDeviceAdd);
    config.EvtDriverUnload = UsbDriverUnload;

    NTSTATUS status = WdfDriverCreate(DriverObject,
                                      RegistryPath,
                                      WDF_NO_OBJECT_ATTRIBUTES,
                                      &config,
                                      WDF_NO_HANDLE);

    TRACE_FUNCTION_EXIT_NTSTATUS(TRACE_DRIVER, status);

    if (!NT_SUCCESS(status))
    {
        WPP_CLEANUP(DriverObject);
    }

    return status;
}

VOID UsbDriverUnload(_In_ WDFDRIVER Driver)
{
    UNREFERENCED_PARAMETER(Driver);
    TRACE_FUNCTION_ENTRY(TRACE_DRIVER);
    WPP_CLEANUP(WdfDriverWdmGetDriverObject(Driver));
    TRACE_FUNCTION_EXIT(TRACE_DRIVER);
}
```

### Device.cpp, Queue.cpp, Pipeline.cpp

Add tracing to key functions:

```cpp
#include "Device.h"
#include "Trace.h"
#include "Device.tmh"  // Auto-generated

NTSTATUS UsbDevicePrepareHardware(
    _In_ WDFDEVICE device,
    _In_ WDFCMRESLIST resourcesRaw,
    _In_ WDFCMRESLIST resourcesTranslated
)
{
    TRACE_FUNCTION_ENTRY(TRACE_DEVICE);

    auto* context = GetDeviceContext(device);

    // ... existing code ...

    if (!NT_SUCCESS(status))
    {
        TRACE_ERROR(TRACE_DEVICE, "Failed to create USB device: %!STATUS!", status);
        return status;
    }

    TRACE_INFO(TRACE_DEVICE, "USB device prepared successfully (VID:0x%04X PID:0x%04X)",
               descriptor.idVendor, descriptor.idProduct);

    TRACE_FUNCTION_EXIT_NTSTATUS(TRACE_DEVICE, status);
    return status;
}
```

## Trace Flags

### UsbTransportUmdf
- `TRACE_DRIVER` - Driver initialization/unload
- `TRACE_DEVICE` - Device PnP events
- `TRACE_QUEUE` - IOCTL queue processing
- `TRACE_USB` - USB operations (pipes, transfers)
- `TRACE_IOCTL` - IOCTL handling details
- `TRACE_TOUCH` - Touch data processing

### UsbDisplayIdd
- `TRACE_DRIVER` - Driver initialization/unload
- `TRACE_DEVICE` - Device events
- `TRACE_DISPLAY` - IddCx adapter/monitor events
- `TRACE_PIPELINE` - Frame processing pipeline
- `TRACE_SWAPCHAIN` - Swap-chain operations
- `TRACE_PRESENT` - Present operations

### UsbTouchHidUmdf
- `TRACE_DRIVER` - Driver initialization/unload
- `TRACE_DEVICE` - Device events
- `TRACE_HID` - HID descriptor handling
- `TRACE_TOUCH` - Touch data processing
- `TRACE_REPORT` - HID report generation

## Collecting Traces

### Method 1: Using tracelog.exe

```batch
REM Start trace session
tracelog -start UsbTransportTrace -guid #8A1F9517-3A8C-4A9E-B5F2-6E8C9B4A7D3E -f UsbTransport.etl -flag 0x3F -level 5

REM Stop trace session
tracelog -stop UsbTransportTrace

REM Format trace to text
tracefmt UsbTransport.etl -o UsbTransport.txt -p C:\Path\To\TMF
```

### Method 2: Using logman (Windows built-in)

```batch
REM Create trace session
logman create trace UsbDisplayTrace -p {2B4E8F6A-9C3D-4B1E-A7F8-5D9E2C4B6A1F} 0xFFFFFFFF 5 -o UsbDisplay.etl

REM Start tracing
logman start UsbDisplayTrace

REM Stop tracing
logman stop UsbDisplayTrace

REM Delete session
logman delete UsbDisplayTrace
```

### Method 3: Using WPP IFR (In-Flight Recorder)

For debugging crashes and hangs, enable WPP IFR:

```cpp
// In WPP configuration
#define WPP_RECORDER_LEVEL_FLAGS_FILTER(lvl,flags) (lvl < TRACE_LEVEL_VERBOSE)
```

Then use `!wdfkd.wdflogdump` in WinDbg to extract traces.

## Trace Levels

- `TRACE_LEVEL_CRITICAL` (1) - Critical errors
- `TRACE_LEVEL_ERROR` (2) - Errors
- `TRACE_LEVEL_WARNING` (3) - Warnings
- `TRACE_LEVEL_INFORMATION` (4) - Informational messages
- `TRACE_LEVEL_VERBOSE` (5) - Verbose debugging

## Example Trace Messages

### Good Examples

```cpp
// USB transfer
TRACE_INFO(TRACE_USB, "Sending frame %llu, size=%lu bytes",
           context->Statistics.FramesSubmitted, frameSize);

// Error with details
TRACE_ERROR(TRACE_IOCTL, "IOCTL_RPUSB_PUSH_FRAME failed: buffer too small (expected=%lu, got=%lu)",
            requiredSize, actualSize);

// Touch event
TRACE_VERBOSE(TRACE_TOUCH, "Touch contact %u: TipSwitch=%u, X=%u, Y=%u",
              contactId, tipSwitch, x, y);

// Performance monitoring
TRACE_INFO(TRACE_PRESENT, "Frame processing time: %llu microseconds",
           processingTime);
```

### Bad Examples (Avoid)

```cpp
// Too vague
TRACE_ERROR(TRACE_DEVICE, "Error occurred");

// Missing important context
TRACE_INFO(TRACE_USB, "Transfer completed");

// Excessive verbosity in hot path
TRACE_VERBOSE(TRACE_PRESENT, "Processing pixel %u of %u", pixelIndex, totalPixels);
```

## Best Practices

1. **Function Entry/Exit**: Use `TRACE_FUNCTION_ENTRY` and `TRACE_FUNCTION_EXIT` for all public functions
2. **Error Context**: Always include NTSTATUS codes and relevant parameters in error traces
3. **Performance**: Avoid tracing in tight loops (per-pixel, per-byte)
4. **Security**: Never trace sensitive data (passwords, keys, user data)
5. **Levels**: Use appropriate levels - don't use ERROR for expected conditions

## Performance Impact

- **Minimal** when tracing is disabled (compiled out in Release builds)
- **Low** when enabled but not collected (~1-2% overhead)
- **Moderate** when actively collecting to file (~5-10% overhead)
- **High** if using TRACE_LEVEL_VERBOSE in hot paths

## Troubleshooting

### "TraceEvents not defined"

Ensure you've included the `.tmh` file:
```cpp
#include "MyFile.tmh"  // Must be after Trace.h
```

### "WPP_INIT_TRACING not found"

Enable WPP in project settings and rebuild.

### No trace output

1. Check trace session is running: `tracelog -l`
2. Verify GUID matches Trace.h
3. Ensure trace level is high enough
4. Check TMF files are in search path

## References

- [WPP Software Tracing](https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/wpp-software-tracing)
- [Trace Message Format Files](https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/trace-message-format-file)
- [Tracelog](https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/tracelog)
- [Tracefmt](https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/tracefmt)
